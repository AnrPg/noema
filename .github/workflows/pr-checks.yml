# =============================================================================
# Noema PR Checks
# =============================================================================
# Runs additional checks on pull requests
# Includes PR title validation, size checks, and dependency review
# =============================================================================

name: PR Checks

on:
    pull_request:
        types: [opened, edited, synchronize, reopened]

jobs:
    # ===========================================================================
    # PR Title Validation (Conventional Commits)
    # ===========================================================================
    pr-title:
        name: PR Title
        runs-on: ubuntu-latest
        steps:
            - name: Check PR title
              uses: amannn/action-semantic-pull-request@v5
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  types: |
                      feat
                      fix
                      docs
                      style
                      refactor
                      perf
                      test
                      build
                      ci
                      chore
                      revert
                  requireScope: false
                  subjectPattern: ^[A-Z].+$
                  subjectPatternError: |
                      The subject "{subject}" must start with an uppercase letter.

    # ===========================================================================
    # PR Size Check
    # ===========================================================================
    pr-size:
        name: PR Size
        runs-on: ubuntu-latest
        steps:
            - name: Check PR size
              uses: CodelyTV/pr-size-labeler@v1
              with:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  xs_label: "size/XS"
                  xs_max_size: 10
                  s_label: "size/S"
                  s_max_size: 100
                  m_label: "size/M"
                  m_max_size: 500
                  l_label: "size/L"
                  l_max_size: 1000
                  xl_label: "size/XL"
                  fail_if_xl: false
                  message_if_xl: >
                      This PR is quite large. Consider breaking it down into smaller PRs
                      for easier review.

    # ===========================================================================
    # Dependency Review
    # ===========================================================================
    dependency-review:
        name: Dependency Review
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Dependency Review
              uses: actions/dependency-review-action@v4
              with:
                  fail-on-severity: high
                  deny-licenses: GPL-3.0, AGPL-3.0
                  allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD

    # ===========================================================================
    # Check for Sensitive Data
    # ===========================================================================
    secrets-scan:
        name: Secrets Scan
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: TruffleHog Secrets Scan
              uses: trufflesecurity/trufflehog@main
              with:
                  extra_args: --only-verified
