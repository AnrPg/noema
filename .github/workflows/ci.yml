# =============================================================================
# Continuous Integration Workflow
# =============================================================================
# Runs on every push and pull request to ensure code quality
# =============================================================================

name: CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    NODE_VERSION: "20"
    PNPM_VERSION: "9.14.4"
    PYTHON_VERSION: "3.12"

jobs:
    # ===========================================================================
    # Detect Changes - Determines which jobs to run
    # ===========================================================================
    changes:
        name: Detect Changes
        runs-on: ubuntu-latest
        outputs:
            packages: ${{ steps.changes.outputs.packages }}
            services: ${{ steps.changes.outputs.services }}
            agents: ${{ steps.changes.outputs.agents }}
            apps: ${{ steps.changes.outputs.apps }}
            infrastructure: ${{ steps.changes.outputs.infrastructure }}
        steps:
            - uses: actions/checkout@v4

            - uses: dorny/paths-filter@v3
              id: changes
              with:
                  filters: |
                      packages:
                        - 'packages/**'
                      services:
                        - 'services/**'
                      agents:
                        - 'agents/**'
                      apps:
                        - 'apps/**'
                      infrastructure:
                        - 'infrastructure/**'
                        - 'docker-compose*.yml'
                        - 'Dockerfile*'

    # ===========================================================================
    # Install Dependencies & Cache
    # ===========================================================================
    setup:
        name: Setup
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Cache node_modules
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      packages/*/node_modules
                      services/*/node_modules
                      apps/*/node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-

    # ===========================================================================
    # Lint - Check code style and quality
    # ===========================================================================
    lint:
        name: Lint
        runs-on: ubuntu-latest
        needs: setup
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Restore cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      packages/*/node_modules
                      services/*/node_modules
                      apps/*/node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run ESLint
              run: pnpm lint

            - name: Check formatting
              run: pnpm format:check

    # ===========================================================================
    # Type Check - Verify TypeScript types
    # ===========================================================================
    typecheck:
        name: Type Check
        runs-on: ubuntu-latest
        needs: setup
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Restore cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      packages/*/node_modules
                      services/*/node_modules
                      apps/*/node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run TypeScript
              run: pnpm typecheck

    # ===========================================================================
    # Build - Compile all packages and services
    # ===========================================================================
    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [lint, typecheck]
        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Restore cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      packages/*/node_modules
                      services/*/node_modules
                      apps/*/node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build
              run: pnpm build

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-output
                  path: |
                      packages/*/dist
                      services/*/dist
                  retention-days: 1

    # ===========================================================================
    # Test - Run unit and integration tests
    # ===========================================================================
    test:
        name: Test
        runs-on: ubuntu-latest
        needs: build
        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_USER: noema
                    POSTGRES_PASSWORD: noema_test
                    POSTGRES_DB: noema_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

            redis:
                image: redis:7-alpine
                ports:
                    - 6379:6379
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Restore cache
              uses: actions/cache@v4
              with:
                  path: |
                      node_modules
                      packages/*/node_modules
                      services/*/node_modules
                      apps/*/node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-output

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run tests
              run: pnpm test:coverage
              env:
                  DATABASE_URL: postgresql://noema:noema_test@localhost:5432/noema_test
                  REDIS_URL: redis://localhost:6379
                  NODE_ENV: test

            - name: Upload coverage
              uses: codecov/codecov-action@v4
              with:
                  files: ./coverage/lcov.info
                  fail_ci_if_error: false

    # ===========================================================================
    # Python Agents - Lint and test Python code
    # ===========================================================================
    python-agents:
        name: Python Agents
        runs-on: ubuntu-latest
        needs: changes
        if: needs.changes.outputs.agents == 'true'
        steps:
            - uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: "pip"
                  cache-dependency-path: agents/requirements*.txt

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r agents/requirements.txt
                  pip install -r agents/requirements-dev.txt

            - name: Run linting
              run: |
                  cd agents
                  ruff check .
                  ruff format --check .

            - name: Run type checking
              run: |
                  cd agents
                  mypy .

            - name: Run tests
              run: |
                  cd agents
                  pytest --cov=. --cov-report=xml

    # ===========================================================================
    # Docker Build - Verify Docker images build correctly
    # ===========================================================================
    docker-build:
        name: Docker Build
        runs-on: ubuntu-latest
        needs: [changes, build]
        if: needs.changes.outputs.infrastructure == 'true' || needs.changes.outputs.services == 'true'
        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Node.js base image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: infrastructure/docker/base/Dockerfile.node
                  push: false
                  tags: noema/node:test
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build Python base image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: infrastructure/docker/base/Dockerfile.python
                  push: false
                  tags: noema/python:test
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
